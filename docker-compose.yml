# ═══════════════════════════════════════════════════════════════════════════
# PocketPilot Ultimate - Docker Compose Configuration
# ═══════════════════════════════════════════════════════════════════════════
# 
# DATABASE OPTIONS:
# ─────────────────
# 1. SUPABASE (Recommended for production):
#    - Set DATABASE_MODE=supabase in backend/.env
#    - Set your SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY
#    - Comment out or remove the 'db' service below
#
# 2. LOCAL POSTGRESQL (via Docker):
#    - Set DATABASE_MODE=local in backend/.env
#    - Uncomment the 'db' service below
#
# 3. MOCK DATABASE (for quick development):
#    - Set DATABASE_MODE=mock in backend/.env  
#    - No real database needed
#
# ═══════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Local PostgreSQL Database (Optional - comment out if using Supabase)
  # ─────────────────────────────────────────────────────────────────────────
  # db:
  #   image: postgres:16
  #   restart: always
  #   ports:
  #     - "5432:5432"
  #   environment:
  #     POSTGRES_USER: pocketsaver
  #     POSTGRES_PASSWORD: hunter2
  #     POSTGRES_DB: pocketsaver
  #   volumes:
  #     - db-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD", "pg_isready", "-U", "pocketsaver"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5

  # ─────────────────────────────────────────────────────────────────────────
  # Backend API Server
  # ─────────────────────────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "5001:5000"              # host:container
    env_file:
      - ./backend/.env
    # Uncomment below if using local PostgreSQL
    # depends_on:
    #   db:
    #     condition: service_healthy
    volumes:
      - ./backend:/usr/src/app   # live‐reload backend
    command: npm run dev

  # ─────────────────────────────────────────────────────────────────────────
  # Frontend Next.js App
  # ─────────────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3001:3000"              # host:container
    env_file:
      - ./frontend/.env.local
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:4000
    depends_on:
      - backend
    volumes:
      - ./frontend:/app          # live‐reload frontend
      - /app/node_modules        # preserve container's modules
    command: npm run dev

# ─────────────────────────────────────────────────────────────────────────
# Volumes (uncomment if using local PostgreSQL)
# ─────────────────────────────────────────────────────────────────────────
# volumes:
#   db-data: